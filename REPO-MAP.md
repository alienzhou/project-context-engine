# Repo Map: æ™ºèƒ½ä»£ç ä»“åº“åœ°å›¾ç”Ÿæˆå™¨

`Repo Map` æ˜¯ä¸€ä¸ªå¼ºå¤§çš„é™æ€ä»£ç åˆ†æå·¥å…·ï¼Œæ—¨åœ¨ä¸ºä»£ç ä»“åº“ç”Ÿæˆä¸€ä¸ªç®€æ´ã€æ™ºèƒ½çš„"åœ°å›¾"ã€‚å®ƒèƒ½æå–å‡ºé¡¹ç›®ä¸­æœ€é‡è¦çš„ç±»ã€å‡½æ•°å’Œæ¥å£ç­‰ç¬¦å·ï¼Œå¹¶ä»¥æ¸…æ™°çš„ç»“æ„å±•ç¤ºå®ƒä»¬ä¹‹é—´çš„å…³ç³»ï¼Œå¸®åŠ©å¼€å‘è€…å’ŒAIå¿«é€Ÿç†è§£ä»£ç åº“çš„æ ¸å¿ƒç»“æ„ã€‚

å…¶è®¾è®¡çµæ„Ÿæ¥æºäº [aider.chat](https://aider.chat/docs/repomap.html) çš„ç†å¿µï¼Œå¹¶é€šè¿‡æ›´å…ˆè¿›çš„åˆ†æå’Œæ ¼å¼åŒ–åŠŸèƒ½è¿›è¡Œäº†å¢å¼ºã€‚

## æ ¸å¿ƒç‰¹æ€§

- ğŸ§  **æ™ºèƒ½åˆ†æ**ï¼šä½¿ç”¨ Tree-sitter ç²¾ç¡®è§£æä»£ç ï¼Œæå–è¶…è¿‡14ç§ä¸åŒç±»å‹çš„ç¬¦å·ï¼ˆç±»ã€å‡½æ•°ã€æšä¸¾ã€æ¥å£ç­‰ï¼‰ã€‚
- ğŸ“Š **é‡è¦æ€§æ’åº**ï¼šç»“åˆ PageRank ç®—æ³•å’Œå¤šç§å¯å‘å¼è§„åˆ™ï¼Œæ™ºèƒ½è¯„ä¼°æ–‡ä»¶å’Œç¬¦å·çš„é‡è¦æ€§ï¼Œä¼˜å…ˆå±•ç¤ºæ ¸å¿ƒä»£ç ã€‚
- ğŸŒ **å¤šè¯­è¨€æ”¯æŒ**ï¼šå…¨é¢æ”¯æŒ JavaScript, TypeScript, Python, Java, Go, C++, React ç­‰å¤šç§ä¸»æµç¼–ç¨‹è¯­è¨€å’Œæ¡†æ¶ã€‚
- ğŸ¯ **Token æ§åˆ¶**ï¼šæ™ºèƒ½æ§åˆ¶è¾“å‡ºå†…å®¹çš„é•¿åº¦ï¼Œç¡®ä¿å…¶èƒ½è½»æ¾é€‚é…å„ç±»å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰çš„ä¸Šä¸‹æ–‡çª—å£ã€‚
- ğŸ¨ **å¯è§†åŒ–è¾“å‡º**ï¼šä½¿ç”¨å›¾æ ‡ï¼ˆå¦‚ ğŸ›ï¸, âš¡, ğŸ”§ï¼‰å’Œä¿®é¥°ç¬¦ï¼ˆå¦‚ `[export]`, `[async]`ï¼‰å¢å¼ºè¾“å‡ºçš„å¯è¯»æ€§ã€‚
- âš™ï¸ **çµæ´»é…ç½®**ï¼šæä¾›ä¸°å¯Œçš„é…ç½®é€‰é¡¹ï¼Œå¯è‡ªå®šä¹‰è¾“å‡ºçš„è¯¦ç»†ç¨‹åº¦å’Œæ ¼å¼ã€‚
- å‘½ä»¤è¡Œä¸APIï¼šæ”¯æŒé€šè¿‡å‘½ä»¤è¡Œï¼ˆCLIï¼‰å’Œç¨‹åºåŒ–æ¥å£ï¼ˆAPIï¼‰ä¸¤ç§æ–¹å¼ä½¿ç”¨ï¼Œæ–¹ä¾¿é›†æˆåˆ°å„ç§å·¥ä½œæµä¸­ã€‚

## æ”¯æŒçš„è¯­è¨€

| è¯­è¨€ | æ‰©å±•å | æ”¯æŒçŠ¶æ€ |
| :--- | :--- | :--- |
| JavaScript/TypeScript | .js, .ts, .jsx, .tsx, .mjs, .cjs | âœ… å®Œå…¨æ”¯æŒ |
| Java | .java | âœ… å®Œå…¨æ”¯æŒ |
| Kotlin | .kt, .kts | âœ… å®Œå…¨æ”¯æŒ |
| Go | .go | âœ… å®Œå…¨æ”¯æŒ |
| C/C++ | .c, .cpp, .h, .hpp, .cc, .cxx | âœ… å®Œå…¨æ”¯æŒ |
| Python | .py, .pyw | âœ… å®Œå…¨æ”¯æŒ |
| React | .jsx, .tsx | âœ… å®Œå…¨æ”¯æŒ |
| Rust | .rs | âœ… å®Œå…¨æ”¯æŒ |
| Swift | .swift | âœ… å®Œå…¨æ”¯æŒ |
| C# | .cs | âœ… å®Œå…¨æ”¯æŒ |
| Shell | .sh, .bash | âœ… åŸºæœ¬æ”¯æŒ |
| é…ç½® | .json, .yaml | âœ… åŸºæœ¬æ”¯æŒ |

## å¿«é€Ÿä¸Šæ‰‹

### 1. å®‰è£…ä¸æ„å»º

é¦–å…ˆï¼Œè¯·ç¡®ä¿æ‚¨å·²å®‰è£… `pnpm`ã€‚

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•å®‰è£…ä¾èµ–
pnpm install

# æ„å»ºé¡¹ç›®
pnpm build
```

### 2. ä½¿ç”¨æ–¹æ³•

#### å‘½ä»¤è¡Œ (CLI)

ä½ å¯ä»¥é€šè¿‡ CLI å¿«é€Ÿä¸ºä»»ä½•é¡¹ç›®ç”Ÿæˆ Repo Mapã€‚

```bash
# åŸºæœ¬ç”¨æ³•ï¼šä¸ºæŒ‡å®šç›®å½•ç”Ÿæˆ repo mapï¼Œå¹¶æ‰“å°åˆ°æ§åˆ¶å°
node apps/analyzer/dist/code-analyzer/repomap/cli.js <path/to/your/repo>

# ä¿å­˜åˆ°æ–‡ä»¶
node apps/analyzer/dist/code-analyzer/repomap/cli.js <path/to/your/repo> repomap.md

# æ§åˆ¶ token æ•°é‡
node apps/analyzer/dist/code-analyzer/repomap/cli.js <path/to/your/repo> repomap.md 2048

# ç”Ÿæˆ JSON æ ¼å¼è¾“å‡º
node apps/analyzer/dist/code-analyzer/repomap/cli.js <path/to/your/repo> repomap.json 4096 json
```

#### ç¨‹åºåŒ–æ¥å£ (API)

å°† Repo Map åŠŸèƒ½é›†æˆåˆ°ä½ è‡ªå·±çš„å·¥å…·æˆ–æœåŠ¡ä¸­ä¹Ÿéå¸¸ç®€å•ã€‚

```typescript
import { generateRepoMap } from './apps/analyzer/src/code-analyzer/repomap';
// æ³¨æ„ï¼šè¯·æ ¹æ®ä½ çš„é¡¹ç›®ç»“æ„è°ƒæ•´å¯¼å…¥è·¯å¾„

async function main() {
  const result = await generateRepoMap('./path/to/your/repo', {
    maxTokens: 2048,
  });

  console.log(result.map);

  // ä¹Ÿå¯ä»¥è®¿é—®è¯¦ç»†çš„ç»“æ„åŒ–æ•°æ®
  // console.log(JSON.stringify(result.files, null, 2));
}

main();
```

## è¾“å‡ºç¤ºä¾‹ (æ–‡æœ¬æ ¼å¼)

ä»¥ä¸‹æ˜¯æˆ‘ä»¬åˆšåˆšç”Ÿæˆçš„ `test-multilang` ç›®å½•çš„ Repo Map ç¤ºä¾‹ï¼Œå±•ç¤ºäº†å…¶ä¸°å¯Œçš„å¯è§†åŒ–è¾“å‡ºï¼š

```
javascript/userService.js:
â‹®...
â”‚ğŸ›ï¸ class UserService { } [export]
â”‚  ğŸ”§ update(id, updates) { }
â”‚  ğŸ”§ _validateUser(user) { }
â”‚  ğŸ”§ create(userData) { }
â”‚  ğŸ”§ findById(id) { }
â”‚  ğŸ”§ delete(id) { }
â‹®...
â”‚ğŸ›ï¸ class EventEmitter { }
â”‚  ğŸ”§ on(event, listener) { }
â”‚  ğŸ”§ emit(event, ...args) { }
â”‚  ğŸ”§ off(event, listenerToRemove) { }
â‹®...
â”‚âš¡ function withRetry(fn, maxRetries = 3, delay = 1000) { }

typescript/UserService.ts:
â‹®...
â”‚ğŸ›ï¸ class UserService { }
â”‚  ğŸ”§ findById(id: number) { }
â”‚  ğŸ”§ save(user: User) { }
â”‚  ğŸ”§ delete(id: number) { }
â‹®...
â”‚âš¡ğŸ”„ async function withRetry<T extends (...args: any[]) => Promise<any>>(
  fn: T,
  maxRetries: number = 3
) { } [export]

react/UserCard.tsx:
â‹®...
â”‚âš¡ function useUserActions(user: User, onEdit?: (user: User) => void, onDelete?: (userId: number) => void) { }
â‹®...
â”‚âš¡ StatusBadge: React.FC<StatusBadgeProps> = ({ status }) => { }
```

## é…ç½®é€‰é¡¹

ä½ å¯ä»¥é€šè¿‡ `RepoMapOptions` å¯¹è±¡è‡ªå®šä¹‰ç”Ÿæˆè¿‡ç¨‹ã€‚

```typescript
interface RepoMapOptions {
  maxTokens?: number;        // æœ€å¤§tokenæ•°ï¼Œé»˜è®¤1024
  includeTypes?: boolean;    // æ˜¯å¦åŒ…å«ç±»å‹å®šä¹‰ï¼Œé»˜è®¤true
  includeVariables?: boolean; // æ˜¯å¦åŒ…å«å˜é‡ï¼Œé»˜è®¤false
  minImportance?: number;    // æ˜¾ç¤ºç¬¦å·çš„æœ€å°é‡è¦æ€§é˜ˆå€¼ï¼Œé»˜è®¤0.5
  rootPath: string;         // è¦åˆ†æçš„ä»“åº“æ ¹ç›®å½•è·¯å¾„
}
```

## æœ€ä½³å®è·µ

### æ§åˆ¶è¾“å‡ºå¤§å°

- å¯¹äºå¤§å‹é¡¹ç›®ï¼Œé€‚å½“å¢åŠ  `maxTokens` ä»¥è·å–æ›´å®Œæ•´çš„è§†å›¾ã€‚
- å¯¹äºå¿«é€Ÿæ¦‚è§ˆæˆ–å°å‹é¡¹ç›®ï¼Œå¯ä»¥ä½¿ç”¨è¾ƒå°çš„ `maxTokens` (å¦‚ 512 æˆ– 1024)ã€‚

### è¿‡æ»¤ç¬¦å·

- `minImportance`: æé«˜æ­¤é˜ˆå€¼å¯ä»¥è¿‡æ»¤æ‰ä¸é‚£ä¹ˆé‡è¦çš„ç¬¦å·ï¼Œåªå…³æ³¨æ ¸å¿ƒé€»è¾‘ã€‚
- `includeVariables`: å¦‚æœä½ å…³å¿ƒå¸¸é‡æˆ–å…¨å±€å˜é‡çš„å®šä¹‰ï¼Œå¯ä»¥å°†å…¶è®¾ä¸º `true`ã€‚

### é›†æˆåˆ° CI/CD

ä½ å¯ä»¥å°† Repo Map ç”Ÿæˆæ­¥éª¤æ·»åŠ åˆ°ä½ çš„ CI/CD æµç¨‹ä¸­ï¼Œä»¥ä¾¿æ¯æ¬¡ä»£ç å˜æ›´æ—¶è‡ªåŠ¨æ›´æ–°é¡¹ç›®çš„åœ°å›¾ã€‚

```yaml
# .github/workflows/repomap.yml
name: Generate Repo Map
on: [push]

jobs:
  repomap:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: pnpm/action-setup@v2
        with:
          version: 8
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install
      
      - name: Build
        run: pnpm build

      - name: Generate repo map
        run: node apps/analyzer/dist/code-analyzer/repomap/cli.js . repomap.md 4096

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: repomap
          path: repomap.md
```

## å¸¸è§é—®é¢˜ (FAQ)

- **Q: ä¸ºä»€ä¹ˆæŸäº›å‡½æ•°æˆ–ç±»æ²¡æœ‰åœ¨åœ°å›¾ä¸­æ˜¾ç¤º?**
  A: Repo Map ä¼šåŸºäºé‡è¦æ€§å¯¹ç¬¦å·è¿›è¡Œæ’åºå’Œè¿‡æ»¤ã€‚å¦‚æœä¸€ä¸ªç¬¦å·æ²¡æœ‰è¢«å¯¼å‡ºï¼Œæ²¡æœ‰è¢«å…¶ä»–æ–‡ä»¶å¼•ç”¨ï¼Œä¸”æœ¬èº«ç±»å‹æƒé‡ä¸é«˜ï¼Œå®ƒå¯èƒ½è¢«è®¤ä¸ºæ˜¯æ¬¡è¦çš„è€Œä¸æ˜¾ç¤ºã€‚ä½ å¯ä»¥å°è¯•è°ƒä½ `minImportance` é˜ˆå€¼ã€‚

- **Q: è¾“å‡ºç»“æœä¸ºä»€ä¹ˆè¢«æˆªæ–­äº†?**
  A: è¿™æ˜¯ç”± `maxTokens` å‚æ•°æ§åˆ¶çš„ã€‚ä¸ºäº†ä¿è¯è¾“å‡ºçš„ç®€æ´æ€§ï¼Œå½“è¾¾åˆ° token é™åˆ¶æ—¶ä¼šåœæ­¢æ·»åŠ æ–°å†…å®¹ã€‚å¦‚æœéœ€è¦æ›´å®Œæ•´çš„åœ°å›¾ï¼Œè¯·å¢å¤§ `maxTokens` çš„å€¼æˆ–ä½¿ç”¨ `json` æ ¼å¼è¾“å‡ºã€‚

- **Q: æˆ‘å¯ä»¥æ·»åŠ å¯¹æ–°è¯­è¨€çš„æ”¯æŒå—?**
  A: å½“ç„¶å¯ä»¥ã€‚è¿™éœ€è¦æ›´æ–°å†…éƒ¨çš„è¯­è¨€æ˜ å°„é…ç½®ï¼Œå¹¶ç¡®ä¿ç›¸åº”çš„ Tree-sitter WASM è§£æå™¨å¯ç”¨ã€‚è¯¦æƒ…è¯·å‚è€ƒ[æŠ€æœ¯æŒ‡å—](./REPO-MAP-TECHNICAL.md)ã€‚

---
æƒ³æ·±å…¥äº†è§£å®ç°ç»†èŠ‚ï¼Ÿè¯·é˜…è¯»æˆ‘ä»¬çš„ [**æŠ€æœ¯æŒ‡å— (REPO-MAP-TECHNICAL.md)**](./REPO-MAP-TECHNICAL.md)ã€‚ 